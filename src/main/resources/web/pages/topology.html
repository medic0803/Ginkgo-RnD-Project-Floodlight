<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Floodlight OpenFlow Controller - Topology</title>

    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link href="../bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css"
          rel="stylesheet">

    <!-- DataTables Responsive CSS -->
    <link href="../bower_components/datatables-responsive/css/dataTables.responsive.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <link href="../bower_components/visjs/vis.css" rel="stylesheet"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
        #mynetwork {
            flex: 1;
            height: calc(100vh - 51px);
            border: 1px solid lightgray;
            background-color: #f8f8f8;
        }
        /*#page-wrapper {*/
            /*flex: 1;*/
        /*}*/
        body, html, #wrapper {
            height: auto;
        }
        #page-wrapper {
            /*display: flex;*/
            height: auto;
        }
        /*body, #page-wrapper {*/
            /*display: flex;*/
        /*}*/
        /*.row {*/
            /*display: flex;*/
            /*flex: 1;*/
        /*}*/
    </style>
</head>

<body>

<div id="wrapper">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html" id="home-button-title">Floodlight OpenFlow Controller </a>
        </div>
        <!-- /.navbar-header -->


        <!-- /.navbar-top-links -->
        <div class="navbar-default sidebar" role="navigation">
            <div class="sidebar-nav navbar-collapse">
                <nav id="navMenu"></nav>
            </div>
            <!-- /.sidebar-collapse -->
        </div>
        <!-- /.navbar-static-side -->
    </nav>

    <div id="page-wrapper">
        <!--    kwmtodo: buttton-->
        <div> <p>
            <button id ="button1" type="button" class="btn btn-outline btn-primary" onclick="test()">Primary</button>
            <button id ="button2" type="button" class="btn btn-outline btn-success">Success</button>
            <button id ="button3" type="button" class="btn btn-outline btn-default">Default</button>
            <button id ="button4" type="button" class="btn btn-outline btn-info">Info</button>
            <button id ="button5" type="button" class="btn btn-outline btn-warning">Warning</button>
            <button id ="button6" type="button" class="btn btn-outline btn-danger">Danger</button>
        </p></div>

         <!--/.row-->
        <!--<div class="row">-->
            <div id="mynetwork"></div>
        <!--</div>-->
         <!--/.row-->
    </div>
    <!-- /#page-wrapper -->
    <div id="login-modal-include"></div>


</div>
<!-- /#wrapper -->

<!-- jQuery -->
<script src="../bower_components/jquery/dist/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<!-- Metis Menu Plugin JavaScript -->
<script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>

<!-- DataTables JavaScript -->
<script src="../bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="../bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="../dist/js/sb-admin-2.js"></script>

<!-- Page-Level Demo Scripts - Tables - Use for reference -->

<script src="../js/querystringparser.js"></script>

<script src="../bower_components/visjs/vis.js"></script>
<script src="../bower_components/visjs/googleAnalytics.js"></script>

<script src="../js/jquery.cookie.js"></script>


<!-- Custom scripts to load in HTML -->
<script src="../js/navbar.js"></script>
<script>
    $(function(){
        $("#login-modal-include").load("loginmodal.html");
    });
</script>

<script type="text/javascript">
    /*
     * These cookies are set on the login page at login.html.
     * They are simply the IP address of your controller and the REST api port.
     * */
    var ipaddress = $.cookie('cip');
    if (ipaddress == null || ipaddress == "") window.location.href = "login.html";
    var restport = $.cookie('cport');
    if (restport == null || restport == "") window.location.href = "login.html";


    var nodes = [];
    var edges = [];
    var network = null;

    var DIR = '../bower_components/visjs/img/refresh-cl/';
    var EDGE_LENGTH_MAIN = 50;
    var EDGE_LENGTH_SUB = 50;

    /*
    * This function draws the network and assigns actions to it as well.
    **/
    function draw() {

        // create a network
        var container = document.getElementById('mynetwork');

        var data = {
            nodes: nodes,
            edges: edges
        };

        var options = {
            autoResize: true,
            height: '100%',
            width: '100%'
        };

        network = new vis.Network(container, data, options);
//        network.fit({scale: 4.0});


        //kwm:set the showPopup function is there
        network.on("showPopup", function (params) {
            //kwm: the params in there is the s+mac or h+mac; it is the ID of the element;
            //kwm: the substring(1) is the mac of the host or switch
            if (params.charAt(0) == 's') {
                var id = params.substring(1);
                network["body"]["nodes"][params]["options"]["title"] = parseFlows(id);
            }
            if(params.charAt(0) == 'h'){
                var id = params.substring(1);
                network["body"]["nodes"][params]["options"]["title"] = parseHosts(id);
            }
        });

    }

    loadSwitches();


    //kwmtodo:[000] make the appointment of the router ip, like
    //ae:52:40:f2:32:d8	192.168.12.1
    //3a:ea:56:a8:3e:f6	192.168.23.2

    var Router_IP = '192.168.23.2';
    var Router_Mac = '3a:ea:56:a8:3e:f6';
    var Router_Pair_IP = '192.168.12.1';

    function loadExternalLinks(hosts) {

        var url = "http://" + ipaddress + ":" + restport + "/wm/topology/external-links/json";

        $.ajax({
            url: url,
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    edges.push({
                        from: "s" + data[i]["src-switch"],
                        to: "s" + data[i]["dst-switch"],
                        length: EDGE_LENGTH_MAIN,
                        title: data[i]["src-switch"] + "/" + data[i]["src-port"] + "<br>" + data[i]["dst-switch"] + "/" + data[i]["dst-port"],
                        color: 'red',
                        width: 4
                    });
                }
                //kwmtodo: [002] load the links with the hosts with the rule with ROUTER

                for (var i = 0; i < hosts.length; i++) {
                    if (hosts[i]["attachmentPoint"].length > 0) {
                        if (hosts[i].hasOwnProperty("trueAttachmentPoint") && hosts[i]["trueAttachmentPoint"][0] != null) {
                            edges.push({
                                from: "h" + hosts[i]["mac"],
                                to: "s" + hosts[i]["trueAttachmentPoint"][0].switch, length: EDGE_LENGTH_MAIN,
                                title: hosts[i]["trueAttachmentPoint"][0].switch + "/" + hosts[i]["trueAttachmentPoint"][0].port,
                                color: 'green',
                                width: 2
                            });
                        }
                        else {
                            //kwmtodo: don't know what is the trueAttachmentPoint, but do the method give a special node as router
                            if (hosts[i]["ipv4"] == Router_Pair_IP || hosts[i]["ipv4"] == Router_IP){
                                edges.push({
                                    from: "h" + Router_Mac,
                                    to: "s" + hosts[i]["attachmentPoint"][0].switch, length: EDGE_LENGTH_MAIN,
                                    title: hosts[i]["attachmentPoint"][0].switch + "/" + hosts[i]["attachmentPoint"][0].port,
                                    color: 'blue',
                                    width: 2
                                });
                            }else {
                                edges.push({
                                    from: "h" + hosts[i]["mac"],
                                    to: "s" + hosts[i]["attachmentPoint"][0].switch, length: EDGE_LENGTH_MAIN,
                                    title: hosts[i]["attachmentPoint"][0].switch + "/" + hosts[i]["attachmentPoint"][0].port,
                                    color: 'green',
                                    width: 2
                                });
                            }
                        }
                    }
                }

                loadInternalLinks();
                //draw();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR.responseText);
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " +
                        errorThrown);
            }
        });
    }

    function loadInternalLinks(hosts) {
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/topology/links/json",
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    edges.push({
                        from: "s" + data[i]["src-switch"], to: "s" + data[i]["dst-switch"], length: EDGE_LENGTH_MAIN,
                        title: data[i]["src-switch"] + "/" + data[i]["src-port"] + "<br>" + data[i]["dst-switch"] + "/" + data[i]["dst-port"],
                        width: 3
                    });
                }

                draw();
                //LoadExternalLinks(hosts);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " +
                        errorThrown);
            }
        });
    }

    //kwm: parseHost is here
    function parseHosts(id){
        var hostString = "Host info:";
        $.ajax({
            url:"http://" + ipaddress + ":" + restport + "/wm/device/",
            async: false,
            success: function (devicesobject) {
                for (var i = 0; i < devicesobject["devices"].length; i++) {
                    if (devicesobject["devices"][i]["mac"] == id){
                        //kwm: assume that every host only have one port attached.
                        hostString +=" Using Switch Port: " + JSON.stringify(devicesobject["devices"][i]["attachmentPoint"][0]["port"]);
                        hostString += "<br>";
                        break;
                    }
                }
            }
        });
        return hostString;
    }
    function parseFlows(id) {
        var mac2ip = new Map();
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/device/",
            dataType: 'json',
            async: false,
            success: function(data_response){
                for (var i = 0; i < data_response.devices.length; i++) {
                    //kwm:it it strange that it gives array object return here as mac and ipv4
                    mac2ip.set(data_response.devices[i].mac[0],data_response.devices[i].ipv4[0]);
                }
            }
        });

        var flowString = "";
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/core/switch/" + id + "/flow/json",
            async: false,
            success: function (flowobject) {
                for (var i = 0; i < flowobject["flows"].length; i++) {
                    //kwmtodo:shows flow stats in the popup
                    flowString += "Flow " + i + ":";
                    flowString += "<br>&nbsp;&nbsp;&nbsp;Packet count: " + JSON.stringify(flowobject["flows"][i]["packet_count"]);
                    flowString += "<br>&nbsp;&nbsp;&nbsp;Input port: " + flowobject["flows"][i]["match"]["in_port"];
                    flowString += "<br>&nbsp;&nbsp;&nbsp;Path ID: from" + mac2ip.get(flowobject["flows"][i]["match"]["eth_src"]) +  " ==> "+ mac2ip.get(flowobject["flows"][i]["match"]["eth_dst"]);
                    if (flowobject["flows"][i]["version"] == "OF_13") {
                        flowString += "<br>&nbsp;&nbsp;&nbsp;Actions: " + JSON.stringify(flowobject["flows"][i]["instructions"]["instruction_apply_actions"]["actions"]);
                    }
                    if (flowobject["flows"][i]["version"] == "OF_10") {
                        flowString += "<br>&nbsp;&nbsp;&nbsp;Actions: " + JSON.stringify(flowobject["flows"][i]["actions"]["actions"]);
                    }
                    flowString += "<br>";
                }
            }
        });
        return flowString;
    }


    //kwm: Load switches is there
    function loadSwitches() {
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/core/controller/switches/json",
            success: function (data) {

                for (var i = 0; i < data.length; i++) {
                    //kwm: set the information of switch
                    var id = "s" + data[i]["switchDPID"];
                    var label = "s" + data[i]["switchDPID"];
                    nodes.push({
                        id: id,
                        label: label,
                        image: DIR + 'switch.png',
                        shape: 'image',
                        title: parseFlows(data[i]["switchDPID"])
                    });
                }
                LoadHosts();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " +
                        errorThrown);
            }
        });
    }


    function LoadHosts() {
        $.ajax({
            url: "http://" + ipaddress + ":" + restport + "/wm/device/",
            success: function (hosts) {
                hosts = hosts.devices;
                for (var i = 0; i < hosts.length; i++) {

                    if (hosts[i]["attachmentPoint"].length > 0) {
                        //kwmtodo: [001]  add the hosts and router
                        if (hosts[i]["ipv4"] == Router_IP){
                            Router_Mac = hosts[i]["mac"];
                            var id = "h" + Router_Mac;
                            var label = "Router";
                            nodes.push({
                                id: id,
                                label: label,
                                image: DIR + 'router.png',
                                shape: 'image',
                                title: hosts[i]["mac"]
                            });
                        }else if (hosts[i]["ipv4"] == Router_Pair_IP){
                            continue;
                        }else {
                            var id = "h" + hosts[i]["mac"];
                            var label = "h" + hosts[i]["ipv4"];
                            nodes.push({
                                id: id,
                                label: label,
                                image: DIR + 'Hardware-My-Computer-3-icon.png',
                                shape: 'image',
                                title: hosts[i]["mac"]
                            });
                        }
                    }
                }
                loadExternalLinks(hosts);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR.responseText);
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " +
                        errorThrown);
            }
        });

    }


</script>

<script>
    var group;
    //kwmtodo for test

    function loadGroup() {
        var url = "http://" + ipaddress + ":" + restport + "/ginkgo/showLinks/json";
        $.ajax({
            url: url,
            success: function (data) {
                console.log(data);
                setGoup(data);
            }
        });
    }
    function setGoup(x) {
        group = x;
    }

    function initial() {
        //kwm: hide the button
        for (var i = 1; i <= 6; i++) {$('#button'+i).hide();}
        //kwmtodo： 初始化
        // group = dataSrc;
        loadGroup()
        loadButton(group)
    }
    function loadButton() {
        var index = 1;
        for (var groupID in group) {
            $('#button'+index).text(groupID);
            $('#button'+index).show();
            index++;
        }
    }

    initial();

    // kwmtodo: test the js function
    function test() {
        showGroup(group)
    }


    function showGroup(group) {
        for (var groupID in group){
            for (var pathID in group[groupID]){
                colorLinks(group[groupID][pathID]);
            }
        }
        console.log(edges);
        updateEdges(edges);
    }

    function colorLinks(path) {
        var color = "orange";
        var nodePortSet = new Set();
        for (var j in path){
            nodePortSet.add(path[j].switch+"/"+path[j].port);
        }

        for (var i = 0; i < edges.length; i++) {
            if (edges[i].title.search("br") != -1){
                var npts = edges[i].title.split("<br>");
                var npt1 = npts[0];
                var npt2 = npts[1];
                if (nodePortSet.has(npt1) || nodePortSet.has(npt2)){
                    edges[i].color = color;
                }
            }else {
                if (nodePortSet.has(edges[i].title)){
                    edges[i].color = color;
                }
            }
        }

    }

    function updateEdges(edges){
        network.body.data.edges.update(edges);
    }


</script>

</body>

</html>
